<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Page 4</title>
    <link rel="stylesheet" href="style.css" />

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        onSnapshot,
        doc,
        getDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCLxo3xwV9HHLHNBJ3OOwGH9TNUlOcd810",
        authDomain: "docssystem-53344.firebaseapp.com",
        projectId: "docssystem-53344",
        storageBucket: "docssystem-53344.firebasestorage.app",
        messagingSenderId: "148150761173",
        appId: "1:148150761173:web:6bcb198c8754ec3fbd145c",
        measurementId: "G-NEYY09HB5P",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const container = document.getElementById("file-list");
      const pageNumber = "4";

      let role = "employee";

      onAuthStateChanged(auth, async (user) => {
        if (!user) window.location.href = "login.html";
        const userDoc = await getDoc(doc(db, "users", user.uid));
        role = userDoc.data()?.role || "employee";

        const q = query(
          collection(db, "files"),
          where("page", "==", pageNumber)
        );
        onSnapshot(q, (snapshot) => {
          container.innerHTML = "";
          snapshot.docs.forEach((docItem) => {
            const file = docItem.data();
            let element = "";
            if (file.mimetype?.startsWith("image/")) {
              element = `<img src="${file.url}" alt="${file.name}">`;
            } else if (file.mimetype === "application/pdf") {
              element = `<embed src="${file.url}" type="application/pdf">`;
            } else {
              element = `<a href="${file.url}" target="_blank">${file.name}</a>`;
            }

            if (role === "manager") {
              element += `<div style="margin-top:5px;">
                      <button onclick="updateStatus('${docItem.id}','approved')">Approve</button>
                      <button onclick="updateStatus('${docItem.id}','revise')">Revise</button>
                    </div>`;
            }

            const div = document.createElement("div");
            div.innerHTML = element;
            container.appendChild(div);
          });
        });
      });

      window.updateStatus = async (id, status) => {
        await updateDoc(doc(db, "files", id), { status });
      };

      window.signOutUser = () => signOut(auth);
    </script>
  </head>
  <body>
    <nav>
      <a href="index.html">Home</a>
      <a href="page1.html">Page 1</a>
      <a href="page2.html">Page 2</a>
      <a href="page3.html">Page 3</a>
      <a href="page4.html">Page 4</a>
      <a href="#" onclick="signOutUser()">Sign Out</a>
    </nav>

    <h1>Page 4: Uploaded Files</h1>
    <div id="file-list"></div>
  </body>
</html>
